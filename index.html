<!doctype html>
<html lang="en">
  <head>
    <title>NOAA HRRR Browser</title>
    <meta
      property="og:description"
      content="Browse real-time (FH0) reflectivity values from the NOAA HRRR forecast dataset"
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      html,
      body,
      #map {
        height: 100%;
      }
      .map-overlay {
        font:
          12px/20px "Helvetica Neue",
          Arial,
          Helvetica,
          sans-serif;
        position: absolute;
        width: 250px;
        top: 10px;
        left: 10px;
        padding: 10px;
        z-index: 1;
      }
      .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .map-overlay h2 {
        line-height: 24px;
        display: block;
        margin: 0 0 10px;
      }
      .map-overlay label {
        display: block;
        margin-bottom: 5px;
      }
      .map-overlay input[type="range"] {
        background-color: transparent;
        display: inline-block;
        width: 100%;
        position: relative;
        margin: 0;
        cursor: ew-resize;
      }
      .map-overlay input[type="date"] {
        width: calc(100% - 10px);
        margin-bottom: 10px;
      }
      #hour-value-display {
        font-weight: bold;
        margin-left: 5px;
      }
      #loading-indicator {
        margin-top: 5px;
        font-style: italic;
        color: #555;
        display: none; /* Hidden by default */
      }
      /* Info button styling */
      .info-button {
        background: none;
        border: none;
        color: #0078ff;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 10px;
        top: 10px;
      }

      .info-button:hover {
        color: #0056b3;
      }

      /* Modal styling */
      .modal {
        display: none;
        position: fixed;
        z-index: 2;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 3px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        font:
          12px/20px "Helvetica Neue",
          Arial,
          Helvetica,
          sans-serif;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .close-button {
        color: #666;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 15px;
        top: 10px;
      }

      .close-button:hover,
      .close-button:focus {
        color: #333;
        text-decoration: none;
      }

      .modal-content h2 {
        line-height: 24px;
        display: block;
        margin: 0 0 15px;
        font-size: 16px;
        font-weight: bold;
      }

      .modal-body {
        margin-top: 10px;
        line-height: 1.6;
      }

      .modal-body h3 {
        margin-top: 20px;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: bold;
      }

      .modal-body ul {
        padding-left: 20px;
        margin-top: 5px;
        margin-bottom: 15px;
      }

      .modal-body li {
        margin-bottom: 5px;
      }

      .modal-body p {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="map-overlay top">
      <div class="map-overlay-inner">
        <h2>NOAA HRRR Browser</h2>
        <button
          id="info-button"
          class="info-button"
          title="About this application"
        >
          â“˜
        </button>
        <body>
          Real-time composite reflectivity (FH0)
        </body>
        <label for="date-picker">Date:</label>
        <input type="date" id="date-picker" name="trip-start" />

        <label for="hour-slider"
          >reference time (hours 0-23 UTC):
          <span id="hour-value-display">t00z</span></label
        >
        <input
          id="hour-slider"
          type="range"
          min="0"
          max="23"
          step="1"
          value="0"
        />
        <div id="loading-indicator">Pre-fetching images...</div>
      </div>
    </div>
    <script src="config.js"></script>
    <script>
      // --- Configuration ---
      const TITILER_BASE_URL = "https://raster.eoapi.dev"; // Base URL of your TiTiler instance
      const BBOX = {
        min_lon: -135,
        min_lat: 21,
        max_lon: -61,
        max_lat: 55,
      };

      // Generate TARGET_BBOX string from BBOX
      const TARGET_BBOX = `${BBOX.min_lon},${BBOX.min_lat},${BBOX.max_lon},${BBOX.max_lat}`;

      // Generate MAP_IMAGE_COORDINATES from BBOX
      const MAP_IMAGE_COORDINATES = [
        [BBOX.min_lon, BBOX.max_lat], // Upper Left
        [BBOX.max_lon, BBOX.max_lat], // Upper Right
        [BBOX.max_lon, BBOX.min_lat], // Lower Right
        [BBOX.min_lon, BBOX.min_lat], // Lower Left
      ];

      // Reflectivity Colormap (pre-formatted for URL query string)
      const COLORMAP_PARAM =
        "colormap=[[[5,%2010],%20[0,%20236,%20236,%20255]],%20[[10,%2015],%20[1,%20160,%20246,%20255]],%20[[15,%2020],%20[0,%200,%20246,%20255]],%20[[20,%2025],%20[0,%20255,%200,%20255]],%20[[25,%2030],%20[0,%20200,%200,%20255]],%20[[30,%2035],%20[0,%20144,%200,%20255]],%20[[35,%2040],%20[255,%20255,%200,%20255]],%20[[40,%2045],%20[231,%20192,%200,%20255]],%20[[45,%2050],%20[255,%20144,%200,%20255]],%20[[50,%2055],%20[255,%200,%200,%20255]],%20[[55,%2060],%20[214,%200,%200,%20255]],%20[[60,%2065],%20[192,%200,%200,%20255]],%20[[65,%2070],%20[255,%200,%20255,%20255]],%20[[70,%2075],%20[153,%2085,%20201,%20255]]]";
      const OTHER_TITILER_PARAMS = "bidx=1"; // Keep relevant params
      const HRRR_S3_BASE_URL =
        "https://noaa-hrrr-bdp-pds.s3.amazonaws.com/hrrr.";
      const HRRR_FILE_SUFFIX = "/conus/hrrr.";
      const HRRR_FILE_TYPE = ".wrfsfcf00.grib2";

      const HRRR_SOURCE_ID = "hrrr-image-source";
      const HRRR_LAYER_ID = "hrrr-image-layer";

      // State Variables
      let isLayerInitialized = false;
      let cachedHours = new Set(); // Track which hours have been cached
      let currentAbortController = null; // Track the current fetch request

      // --- Initialize Map ---
      const map = new maplibregl.Map({
        container: "map",
        style: `https://api.maptiler.com/maps/backdrop/style.json?key=${window.CONFIG.MAPTILER_API_KEY}`,
        center: [-97.5, 40.0],
        zoom: 3.5,
      });

      // --- Get DOM Elements ---
      const datePicker = document.getElementById("date-picker");
      const hourSlider = document.getElementById("hour-slider");
      const hourValueDisplay = document.getElementById("hour-value-display");
      const loadingIndicator = document.getElementById("loading-indicator");

      // --- Helper Functions ---

      function formatDate(dateString) {
        if (!dateString) return "";
        return dateString.replace(/-/g, "");
      }

      function setDefaultDate() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yyyy = yesterday.getFullYear();
        const mm = String(yesterday.getMonth() + 1).padStart(2, "0");
        const dd = String(yesterday.getDate()).padStart(2, "0");
        datePicker.value = `${yyyy}-${mm}-${dd}`;
      }

      function formatHour(hourNumber) {
        const hourString = String(hourNumber).padStart(2, "0");
        return `t${hourString}z`;
      }

      /**
       * Builds the TiTiler URL to fetch a PNG cropped to a specific bounding box.
       */
      function buildImageUrl(dateStrYYYYMMDD, hourStrTXXz) {
        if (!dateStrYYYYMMDD || !hourStrTXXz) {
          console.warn("Date or Hour is missing, cannot build URL.");
          return null;
        }

        // Create the correct S3 URL with proper encoding for the VRT parameter
        const s3Path = `${HRRR_S3_BASE_URL}${dateStrYYYYMMDD}${HRRR_FILE_SUFFIX}${hourStrTXXz}${HRRR_FILE_TYPE}`;
        const encodedS3Url = encodeURIComponent(`vrt://${s3Path}?bands=1`);

        // Build the final TiTiler URL
        const imageUrl = `${TITILER_BASE_URL}/external/bbox/${TARGET_BBOX}.png?url=${encodedS3Url}&${OTHER_TITILER_PARAMS}&${COLORMAP_PARAM}`;

        return imageUrl;
      }

      /**
       * Initiates browser caching for an image URL without waiting for completion
       */
      function cacheImage(imageUrl) {
        // Use fetch to request the image and cache it
        fetch(imageUrl, {
          method: "GET",
          mode: "cors", // Explicitly request CORS mode
          cache: "default", // Allow browser to use its default caching behavior
        })
          .then((response) => {
            if (!response.ok) {
              console.warn(
                `Failed to cache image: ${response.status} ${response.statusText}`,
              );
            } else {
              console.log(`Successfully cached image: ${imageUrl}`);
            }
          })
          .catch((error) => {
            // Ignore aborted requests as these are expected during fast scrolling
            if (error.name !== "AbortError") {
              console.warn(`Error caching image: ${imageUrl}`, error);
            }
          });
      }
      /**
       * Asynchronously pre-caches images for all hours of the selected date
       */
      async function preCacheImagesForDate(dateStrYYYYMMDD) {
        if (!dateStrYYYYMMDD) {
          console.warn("No date provided for pre-caching");
          return;
        }

        console.log(`Starting pre-cache for date: ${dateStrYYYYMMDD}`);
        loadingIndicator.style.display = "block";
        loadingIndicator.textContent = "Pre-fetching images...";
        cachedHours.clear(); // Reset cached hours for new date

        // Generate all hour strings and start caching in parallel
        for (let hour = 0; hour <= 23; hour++) {
          const hourStrTXXz = formatHour(hour);
          const imageUrl = buildImageUrl(dateStrYYYYMMDD, hourStrTXXz);

          if (imageUrl) {
            cacheImage(imageUrl);
            cachedHours.add(hour);
          }
        }

        loadingIndicator.style.display = "none";
        console.log("Pre-caching initiated for all hours");
      }

      /**
       * Updates the map layer to display the image for the specified hour
       * with request cancellation but no debouncing
       */
      function displayImageForHour(dateStrYYYYMMDD, hourValue) {
        const hourStrTXXz = formatHour(hourValue);
        hourValueDisplay.textContent = hourStrTXXz;

        // Show loading indicator
        loadingIndicator.style.display = "block";
        loadingIndicator.textContent = "Loading...";

        // Build the image URL
        const imageUrl = buildImageUrl(dateStrYYYYMMDD, hourStrTXXz);

        if (!imageUrl) {
          console.error("Could not generate image URL");
          loadingIndicator.style.display = "none";
          return;
        }

        // If this hour hasn't been cached yet, start caching it
        if (!cachedHours.has(hourValue)) {
          cacheImage(imageUrl);
          cachedHours.add(hourValue);
        }

        // Cancel any in-flight requests
        if (currentAbortController) {
          currentAbortController.abort();
        }

        // Create a new abort controller for this request
        currentAbortController = new AbortController();

        // Fetch the image with the ability to cancel
        fetch(imageUrl, {
          signal: currentAbortController.signal,
          cache: "default",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            return response.blob();
          })
          .then((blob) => {
            // Create an object URL from the blob
            const objectUrl = URL.createObjectURL(blob);

            // Update or add the image to the map
            const hrrrSource = map.getSource(HRRR_SOURCE_ID);

            if (hrrrSource && isLayerInitialized) {
              // Update existing source
              hrrrSource.updateImage({
                url: objectUrl,
                coordinates: MAP_IMAGE_COORDINATES,
              });
              console.log(`Updated image for hour ${hourValue}`);
            } else {
              // Initialize source and layer for the first time
              console.log(
                `Initializing image source and layer for hour ${hourValue}`,
              );

              // Remove any stale layer/source
              if (map.getLayer(HRRR_LAYER_ID)) map.removeLayer(HRRR_LAYER_ID);
              if (map.getSource(HRRR_SOURCE_ID))
                map.removeSource(HRRR_SOURCE_ID);

              // Add new source and layer
              map.addSource(HRRR_SOURCE_ID, {
                type: "image",
                url: objectUrl,
                coordinates: MAP_IMAGE_COORDINATES,
              });

              map.addLayer({
                id: HRRR_LAYER_ID,
                type: "raster",
                source: HRRR_SOURCE_ID,
                paint: {
                  "raster-opacity": 0.75,
                  "raster-fade-duration": 0,
                },
              });

              isLayerInitialized = true;
            }

            // Hide loading indicator
            loadingIndicator.style.display = "none";

            // Clean up the object URL after a delay (to ensure it's been used by MapLibre)
            setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
          })
          .catch((error) => {
            // Only log errors that aren't from aborted requests
            if (error.name !== "AbortError") {
              console.error("Error loading image:", error);
              loadingIndicator.textContent =
                "Error loading data. Please try again.";
            } else {
              // For aborted requests, we just reset the loading indicator
              loadingIndicator.style.display = "none";
            }
          });
      }

      // --- Map Load Event ---
      map.on("load", async () => {
        console.log("Map loaded.");
        setDefaultDate();

        const initialDate = formatDate(datePicker.value);
        const initialHour = parseInt(hourSlider.value, 10);

        if (initialDate) {
          // Start pre-caching for all hours (don't wait for completion)
          preCacheImagesForDate(initialDate);

          // Display the initial hour
          displayImageForHour(initialDate, initialHour);
        } else {
          console.warn("Initial date not set, layer not loaded.");
        }

        // --- Event Listeners ---
        datePicker.addEventListener("change", async (e) => {
          const newDate = formatDate(e.target.value);
          const currentHour = parseInt(hourSlider.value, 10);

          if (newDate) {
            // Start pre-caching for the new date
            preCacheImagesForDate(newDate);

            // Display the current hour for the new date
            displayImageForHour(newDate, currentHour);
          }
        });

        hourSlider.addEventListener("input", (e) => {
          const currentDate = formatDate(datePicker.value);
          const newHour = parseInt(e.target.value, 10);

          // Update the hour display immediately for better UX
          hourValueDisplay.textContent = formatHour(newHour);

          if (currentDate) {
            displayImageForHour(currentDate, newHour);
          }
        });
      });

      // --- Error Handling ---
      map.on("error", (e) => {
        console.error("MapLibre Error:", e);

        if (
          e.sourceId === HRRR_SOURCE_ID ||
          (e.source && e.source.id === HRRR_SOURCE_ID)
        ) {
          console.error(
            `Error related to source ${HRRR_SOURCE_ID}. Check TiTiler endpoint, S3 URL validity, and network.`,
            e.error || "",
          );

          // Show user-friendly error message
          loadingIndicator.textContent =
            "Error loading weather data. Please try a different date or hour.";
          loadingIndicator.style.display = "block";

          // Reset initialization flag to try again on next interaction
          isLayerInitialized = false;
        }
      });
      // --- Info Modal Functionality ---
      document.addEventListener("DOMContentLoaded", () => {
        const infoButton = document.getElementById("info-button");
        const infoModal = document.getElementById("info-modal");
        const closeButton = document.querySelector(".close-button");

        // Check if this is the user's first visit
        function isFirstVisit() {
          if (!localStorage.getItem("hrrrBrowserVisited")) {
            localStorage.setItem("hrrrBrowserVisited", "true");
            return true;
          }
          return false;
        }

        // Open the modal
        function openModal() {
          infoModal.style.display = "block";
        }

        // Close the modal
        function closeModal() {
          infoModal.style.display = "none";
        }

        // Event listeners for the modal
        if (infoButton) {
          infoButton.addEventListener("click", openModal);
        } else {
          console.error("Info button not found");
        }

        if (closeButton) {
          closeButton.addEventListener("click", closeModal);
        } else {
          console.error("Close button not found");
        }

        // Close modal when clicking outside of it
        window.addEventListener("click", (event) => {
          if (event.target === infoModal) {
            closeModal();
          }
        });

        // Show modal automatically on first visit (after map loads)
        if (isFirstVisit() && map.loaded()) {
          // Short delay to ensure map is visible first
          setTimeout(openModal, 1000);
        } else if (isFirstVisit()) {
          map.on("load", () => {
            setTimeout(openModal, 1000);
          });
        }
      });
    </script>
    <!-- Info Modal -->
    <div id="info-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>About NOAA HRRR Browser</h2>
        <div class="modal-body">
          <p>
            This application allows you to browse real-time composite
            reflectivity data from the NOAA High-Resolution Rapid Refresh (HRRR)
            weather model.
          </p>

          <h3>How to Use</h3>
          <ul>
            <li>Select a <strong>date</strong> using the date picker</li>
            <li>
              Use the <strong>hour slider</strong> to view data from different
              times (in UTC)
            </li>
            <li>
              The map displays composite reflectivity, which is useful for
              tracking precipitation and storm intensity
            </li>
          </ul>

          <h3>About the Data</h3>
          <p>
            The HRRR is a real-time 3km resolution, hourly updated atmospheric
            model operated by NOAA. This browser displays the "FH0" data, which
            represents the analysis time (not a forecast).
          </p>

          <p>
            Reflectivity values are shown with colors ranging from light blue
            (weak returns) to purple (extreme precipitation).
          </p>

          <p>
            Data is sourced from NOAA's public S3 bucket and rendered using
            TiTiler.
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
